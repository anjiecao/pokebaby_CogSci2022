---
title: "cluster simulation result"
author: "anjie & gal"
date: "12/13/2021"
output: html_document
---

```{r}
library(tidyverse)
library(here)
library(Metrics)
source(here("helper/simulation_results_processing.R"))

basic_res <- readRDS(here("sim_res/01_basic_params.RDS"))

sim_res <- readRDS(here("sim_res/03_param_search_sim.RDS"))
kl_sim_res <- readRDS(here("sim_res/01_KL_tidy_sim.RDS"))
s_sim_res <- readRDS(here("sim_res/03_Surprisal_tidy_sim.RDS"))

#sim_res <- readRDS(here("tidy_sim_res"))
b_res <- read_csv(here("processed_rt_task_data.csv"))

```

# preprocess behavioral results 



```{r}
b_res_print <- b_res %>% 
  mutate(sequence_scheme = case_when(
    deviant_position == 2 ~ "BDBBBB", 
    deviant_position == 4 ~ "BBBDBB", 
    deviant_position == 6 ~ "BBBBBD", 
    TRUE ~ "BBBBBB", 
  ), 
  sequence_scheme_print = case_when(
    sequence_scheme == "BBBBBB" ~ "No Deviant", 
    sequence_scheme == "BDBBBB" ~ "Deviant at 2nd Trial", 
    sequence_scheme == "BBBDBB" ~ "Deviant at 4th Trial", 
    sequence_scheme == "BBBBBD" ~ "Deviant at Last Trial"
  ), 
  log_trial_looking_time = log(trial_looking_time)) %>% 
  separate(block_type, into = c("complexity", "similarity"), sep = "_") %>% 
  select(subject, complexity, trial_number, 
         sequence_scheme, sequence_scheme_print, trial_looking_time, log_trial_looking_time)

# calculate smean.cl.b


b_res_summary <- b_res_print %>% 
  group_by(trial_number, sequence_scheme, sequence_scheme_print, complexity) %>%
  summarise(
    trial_looking_time = mean(trial_looking_time), 
    log_trial_looking_time = mean(log_trial_looking_time)
  ) 

b_res_summary
```


# preprocess simulation results 

```{r}
# tidy up the simulation results for visualization 
basic_res_print <- tidy_up_raw_simulation_results(basic_res, im_type = "basic")
sim_res_print <- tidy_up_raw_simulation_results(sim_res, im_type = "EIG") 
kl_res_print <- tidy_up_raw_simulation_results(kl_sim_res, im_type = "KL")
s_res_print <- tidy_up_raw_simulation_results(s_sim_res, im_type = "surprisal")

# summarizing the results to be compared with the behavioral data 
# no need to summarise the basic because it is already at the trial level 
sim_res_sum <- summarise_tidy_sim_res(sim_res_print)
kl_res_sum <- summarise_tidy_sim_res(kl_res_print)
s_res_sum <- summarise_tidy_sim_res(s_res_print)
```

# put summary together 

```{r}
basic_sim_b_res <- basic_res_print %>% 
  left_join(b_res_summary, c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity"))

sim_b_res <- sim_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity")) 

kl_sim_b_res <- kl_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity"))

s_sim_b_res <- s_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity"))
```


# select the best parameter for scaling 

```{r}

df_basic_r_kl <- calculate_correlation_for_basic_model(basic_sim_b_res, best_for = "KL")
df_basic_r_surprisal <- calculate_correlation_for_basic_model(basic_sim_b_res, best_for = "surprisal")

df_eig_r <- calculate_correlation(sim_b_res)
df_kl_r <- calculate_correlation(kl_sim_b_res)
df_s_r <- calculate_correlation(s_sim_b_res)


df_eig_r
df_kl_r
df_s_r
```



# scaling model results

```{r}
# scaling basic w/ the trial level summary make sense because the other is also just trial level
scaled_basic_sim_b_res <- scale_basic_model(b_res_summary, basic_res_print, best_params = "ap_1_bp_2")

scaled_model_res <- scale_model_results(b_res_print, sim_res_print, best_params = "ae_1_be_10_ap_1_bp_4_np_0.065_wEIG_0.01")
scaled_kl_model_res <- scale_model_results(b_res_print, kl_res_print, best_params = "ae_1_be_10_ap_1_bp_5_np_0.055_wEIG_0.006")
scaled_s_model_res <- scale_model_results(b_res_print, s_res_print, best_params = "ae_1_be_10_ap_1_bp_3_np_0.07_wEIG_8")

```


# saving the scaled model results 

```{r}
scaled_continuous_model_res <- bind_rows(scaled_model_res, scaled_kl_model_res, scaled_s_model_res)

saveRDS(scaled_continuous_model_res, here("scaled_continuous_model_res.RDS"))
saveRDS(scaled_basic_sim_b_res, here("scaled_discrete_model_res.RDS"))
```


# then create new tidy dataframe with scaled results 

```{r}
#scaled_basic_sim_b_res still no needs to summarise this because it is already trial based 

scaled_sim_res_sum <- summarise_scaled_tidy_sim_res(scaled_model_res)
scaled_kl_res_sum <- summarise_scaled_tidy_sim_res(scaled_kl_model_res)
scaled_s_res_sum <- summarise_scaled_tidy_sim_res(scaled_s_model_res)





sim_b_res <- scaled_sim_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity")) 

kl_sim_b_res <- scaled_kl_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity"))

s_sim_b_res <- scaled_s_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "sequence_scheme_print", "complexity"))
```


```{r}

calculate_correlation_for_scaled_basic_model(scaled_basic_sim_b_res)


df_eig_r <- calculate_scaled_correlation(sim_b_res)
df_kl_r <- calculate_scaled_correlation(kl_sim_b_res)
df_s_r <- calculate_scaled_correlation(s_sim_b_res)

df_eig_r
df_kl_r
df_s_r
```





# Visualization 

## behavioral results 


```{r}
b_res_print %>% 
  ggplot(aes(x=trial_number, y=log(trial_looking_time), color = complexity)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2))+
  #geom_smooth(method = "lm", 
  #            formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number")

```




## model results 

### basic model 

```{r}
scaled_basic_sim_b_res %>% 
  pivot_longer(cols = c("scaled_log_surprisal", "scaled_log_kl"), 
               names_to = "im_type", 
               values_to = "im_value") %>% 
  mutate(
    im_type_print = case_when(
      im_type == "scaled_log_surprisal" ~ "Surprisal", 
      im_type == "scaled_log_kl" ~ "KL"
    )
  ) %>% 
  ggplot(aes(x = trial_number, y = im_value, color = complexity)) + 
  geom_point() + 
  geom_line() + 
  facet_grid(im_type_print~sequence_scheme_print) + 
  ylab("Scaled Information Theoretic Measurement (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "Basic Model Comparison") + 
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple"))  +
  theme(legend.position = "bottom") 

scaled_basic_sim_b_res %>% 
  pivot_longer(cols = c("scaled_log_surprisal", "scaled_log_kl"), 
               names_to = "im_type", 
               values_to = "im_value") %>% 
  mutate(
    `Information Theoretic Measurements` = case_when(
      im_type == "scaled_log_surprisal" ~ "Surprisal", 
      im_type == "scaled_log_kl" ~ "KL"
    )
  ) %>% 
  ggplot(aes(x = trial_number, y = im_value, shape = `Information Theoretic Measurements`, linetype = `Information Theoretic Measurements`, color = complexity)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~sequence_scheme) + 
  ylab("Scaled Information Theoretic Measurement (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "Basic Model Comparison") + 
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple"))  +
  theme(legend.position = "bottom") 
```

### basic model with behavioral results 

```{r}
scaled_basic_sim_b_res
```



```{r}
scaled_basic_sim_b_res %>% 
  pivot_longer(cols = c("scaled_log_surprisal", "scaled_log_kl"), 
               names_to = "im_type", 
               values_to = "im_value") %>% 
  mutate(
    im_type_print = case_when(
      im_type == "scaled_log_surprisal" ~ "Surprisal", 
      im_type == "scaled_log_kl" ~ "KL"
    )
  ) %>% 
  ggplot(aes(x = log_trial_looking_time, y = im_value, color = im_type_print)) + 
  geom_point() +
  geom_smooth(method = "lm") + 
  theme_classic() + 
  langcog::scale_color_solarized(name = "Information Theoretic Measurement",labels = c("KL", "Surprisal"))  +
  theme(legend.position = "bottom") + 
  ylab("Scaled Information Theoretic Measurement (log)") + 
  xlab("Trial Looking Time (log)")
```



```{r}
# get KL 
scaled_basic_sim_b_res %>% 
  rename(res_val = scaled_log_kl) %>% 
  select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
  mutate(`Result Type` = "Model") %>% 
  bind_rows(
    b_res_print %>% rename(res_val = log_trial_looking_time) %>% 
      select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
      mutate(`Result Type` = "Behavioral")
  ) %>% 
   ggplot(aes(x=trial_number, y=res_val, color = complexity, linetype = `Result Type`)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot",
                geom = "line", position = position_dodge(width = .2)) +
  
   facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number") + 
  labs(subtitle = paste("Basic Model (KL): r = ", round(head(df_basic_r_kl, 1)$kl_r_log, 2)))  


scaled_basic_sim_b_res %>% 
  rename(res_val = scaled_log_surprisal) %>% 
  select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
  mutate(`Result Type` = "Model") %>% 
  bind_rows(
    b_res_print %>% rename(res_val = log_trial_looking_time) %>% 
      select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
      mutate(`Result Type` = "Behavioral")
  ) %>% 
   ggplot(aes(x=trial_number, y=res_val, color = complexity, linetype = `Result Type`)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot",
                geom = "line", position = position_dodge(width = .2)) +
  
   facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number") + 
  labs(subtitle = paste("Basic Model (Surprisal): r = ", round(head(df_basic_r_surprisal, 1)$surprisal_r_log, 2)))  
```



### three measurements separate

```{r}
bind_rows(scaled_model_res, scaled_kl_model_res, scaled_s_model_res) %>% 
  filter(!is.na(complexity)) %>% 
  ggplot(aes(x = trial_number, y = scaled_log_sample_n, color = complexity)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",position = position_dodge(width = .2)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  facet_grid(im_type~sequence_scheme_print, scales = "free") + 
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  ylab("Sample per trial (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "Model Results: Comparaing Measurements") + 
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple"))  +
  theme(legend.position = "bottom") 
```
### three measurements together 


```{r}
basic_sim_b_res 
```


```{r}
bind_rows(scaled_model_res, scaled_kl_model_res, scaled_s_model_res) %>% 
  filter(!is.na(complexity)) %>% 
  ggplot(aes(x = trial_number, y = scaled_log_sample_n, color = im_type)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",position = position_dodge(width = .2)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  facet_grid(complexity~sequence_scheme_print, scales = "free") + 
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  ylab("Sample per trial (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "Model Results: Comparing Measurements") + 
  langcog::scale_color_solarized(name = "Information Theoretic Measurement",labels = c("EIG", "KL", "surprisal"))  +
  theme(legend.position = "bottom") 
```



(select the best parameters?)



## transformed model results to match mean and standard deviation 



```{r}
#ig_val <- round(head(df_eig_r, 1)$r_in_log, 2)
#eig_title <- expression(paste("EIG: ", italic("r"), " = "))

#plot(1:10, main = expression('Mapped territories of different '*italic(C.~austriacus)*' individuals at the Far Gardens coral reef site'))


scaled_model_res %>% 
  rename(res_val = scaled_log_sample_n) %>% 
  select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
  mutate(`Result Type` = "Model") %>% 
  bind_rows(
    b_res_print %>% rename(res_val = log_trial_looking_time) %>% 
      select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
      mutate(`Result Type` = "Behavioral")
  ) %>% 
   ggplot(aes(x=trial_number, y=res_val, color = complexity, linetype = `Result Type`)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot",
                geom = "line", position = position_dodge(width = .2)) +
  
   facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number") + 
  labs(subtitle = paste("EIG: r = ", round(head(df_eig_r, 1)$r_in_log, 2)))  

scaled_kl_model_res %>% 
  rename(res_val = scaled_log_sample_n) %>% 
  select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
  mutate(`Result Type` = "Model") %>% 
  bind_rows(
    b_res_print %>% rename(res_val = log_trial_looking_time) %>% 
      select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
      mutate(`Result Type` = "Behavioral")
  ) %>% 
   ggplot(aes(x=trial_number, y=res_val, color = complexity, linetype = `Result Type`)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot",
                geom = "line", position = position_dodge(width = .2)) +
  
   facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number") + 
  labs(subtitle = paste("KL: r = ", round(head(df_kl_r, 1)$r_in_log, 2)))  

scaled_s_model_res %>% 
  rename(res_val = scaled_log_sample_n) %>% 
  select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
  mutate(`Result Type` = "Model") %>% 
  bind_rows(
    b_res_print %>% rename(res_val = log_trial_looking_time) %>% 
      select(complexity, trial_number, sequence_scheme, sequence_scheme_print, res_val) %>% 
      mutate(`Result Type` = "Behavioral")
  ) %>% 
   ggplot(aes(x=trial_number, y=res_val, color = complexity, linetype = `Result Type`)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot",
                geom = "line", position = position_dodge(width = .2)) +
  
   facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number") + 
  labs(subtitle = paste("Surprisal: r = ", round(head(df_s_r, 1)$r_in_log, 2)))  

  
```





## correlation between samples and RT 

```{r}
sim_b_res %>% 
  ggplot(aes(x = log(trial_looking_time), 
             y = log(trial_sim_res)
             )) +  
             #color = params_info))  
# scale_x_log10() + 
#  scale_y_log10() + 
  geom_point()  + 
  geom_smooth(method = "lm") + 
  ylab("Looking time (log)") + 
  xlab("Simulation Results (log)")  + 
  theme_classic() #+ 
  #facet_wrap(~sequence_scheme)
```




# Stats

## Calculating perason correlation for each set of parameter (overall)
```{r}
df_eig_r <- calculate_correlation(sim_b_res)
df_kl_r <- calculate_correlation(kl_sim_b_res)
df_s_r <- calculate_correlation(s_sim_b_res)

df_eig_r
df_kl_r
df_s_r
```


```{r}
d <- sim_b_res %>% 
  ungroup() %>% 
  nest_by(params_info) 

d$perason_corr <- unlist(map(d$data, function(x){
   pearson_r <- cor(x$trial_sim_res, x$trial_looking_time, method = "pearson")
    }))
d$perason_corr_in_log <- unlist(map(d$data, function(x){
   pearson_r_in_log <- cor(x$log_trial_sim_res, x$log_trial_looking_time, method = "pearson")
    }))
  
  
d %>% 
  arrange(-perason_corr_in_log)

```

```{r}
best_params <- d %>% arrange(-perason_corr_in_log) %>% head(3)
worst_params <- d %>% arrange(-perason_corr_in_log) %>% tail(3)

sim_res_print %>% 
  filter(params_info %in% best_params$params_info) %>% 
  mutate(params_info =  sub("ae_1_be_10_", "", params_info)) %>% 
  ggplot(aes(x = trial_number, y = log_sample_n, color = complexity)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",position = position_dodge(width = .2)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  facet_grid(sequence_scheme_print ~ params_info) + 
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  ylab("Sample per trial (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "best params") + 
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple"))  +
  theme(legend.position = "bottom") 


sim_res_print %>% 
  filter(params_info %in% worst_params$params_info) %>% 
  mutate(params_info =  sub("ae_1_be_10_", "", params_info)) %>% 
  ggplot(aes(x = trial_number, y = log_sample_n, color = complexity)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",position = position_dodge(width = .2)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  facet_grid(sequence_scheme_print ~ params_info) + 
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  ylab("Sample per trial (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "worst params") + 
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple"))  +
  theme(legend.position = "bottom") 
  
```








# now let's just look at deviant 

```{r}
sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  mutate(
    deviant_position = case_when(
      stimuli_sequence == "BDBBBB" ~ 2, 
      stimuli_sequence == "BBBDBB" ~ 4,
      stimuli_sequence == "BBBBBD" ~ 6, 
      TRUE ~ 0
    ), 
    stimuli_type = case_when(
      stimulus_idx == deviant_position ~ "deviant", 
      TRUE ~ "background"
    )
  ) %>% 
  filter(stimuli_type == "deviant") %>% 
  ggplot(aes(x = deviant_position, y = sample_n, color = stimuli_rep)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~params_info) +
  theme_classic() + 
  labs(title = "absolute sample n for deviant")
```


```{r}
dev_df <- sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  mutate(
    deviant_position = case_when(
      stimuli_sequence == "BDBBBB" ~ 2, 
      stimuli_sequence == "BBBDBB" ~ 4,
      stimuli_sequence == "BBBBBD" ~ 6, 
      TRUE ~ 0
    ), 
    stimuli_type = case_when(
      stimulus_idx == deviant_position ~ "deviant", 
      TRUE ~ "background"
    )
  ) %>% 
  filter(stimuli_type == "deviant") %>% 
  ungroup()

dev_df <- dev_df %>% 
  rename(deviant_n = sample_n) %>% 
  select(stimulus_idx, deviant_n, params_info, stimuli_rep, deviant_position) %>% 
  ungroup() %>% 
  group_by(params_info, stimuli_rep, .drop = FALSE) %>%
  mutate(base_id = row_number())


sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  filter(stimuli_sequence == "BBBBBB") %>%
  rename(background_n = sample_n) %>% 
  filter(stimulus_idx %in% c(2, 4, 6)) %>% 
  ungroup() %>% 
  group_by(params_info, stimuli_rep, .drop = FALSE) %>% 
  mutate(base_id = row_number()) %>% 
  left_join(dev_df, by = c("base_id", "stimuli_rep", "params_info")) %>% 
  mutate(
    relative_dishab = deviant_n - background_n
  ) %>% 
  ggplot(aes(x = deviant_position, y = relative_dishab, color = stimuli_rep)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~params_info) +
  theme_classic() + 
  labs(title = "relative n for deviant")
  
```


```{r}
fam_res <- readRDS(here("model/cached_data/fam_sim_res.RDS"))

```

```{r}
fam_res %>% 
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  filter(!is.na(stimuli_sequence)) %>% 
  ggplot(aes(x = stimulus_idx, y = sample_n, color = stimuli_rep)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~params_info) + 
  theme_classic()
```

