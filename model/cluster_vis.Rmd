---
title: "cluster simulation result"
author: "anjie & gal"
date: "12/13/2021"
output: html_document
---

```{r}
library(tidyverse)
library(here)

sim_res <- readRDS(here("tidy_sim_res3.RDS"))
b_res <- read_csv(here("processed_rt_task_data.csv"))

```

# preprocess behavioral results 
```{r}
b_res_print
```


```{r}
b_res_print <- b_res %>% 
  mutate(sequence_scheme = case_when(
    deviant_position == 2 ~ "BDBBBB", 
    deviant_position == 4 ~ "BBBDBB", 
    deviant_position == 6 ~ "BBBBBD", 
    TRUE ~ "BBBBBB", 
  ), 
  sequence_scheme_print = case_when(
    sequence_scheme == "BBBBBB" ~ "No Deviant", 
    sequence_scheme == "BDBBBB" ~ "Deviant at 2nd Trial", 
    sequence_scheme == "BBBDBB" ~ "Deviant at 4th Trial", 
    sequence_scheme == "BBBBBD" ~ "Deviant at Last Trial"
  )) %>% 
  separate(block_type, into = c("complexity", "similarity"), sep = "_")

# calculate smean.cl.b


b_res_summary <- b_res %>% 
  mutate(sequence_scheme = case_when(
    deviant_position == 2 ~ "BDBBBB", 
    deviant_position == 4 ~ "BBBDBB", 
    deviant_position == 6 ~ "BBBBBD", 
    TRUE ~ "BBBBBB", 
  ), 
  sequence_scheme_print = case_when(
    sequence_scheme == "BBBBBB" ~ "No Deviant", 
    sequence_scheme == "BDBBBB" ~ "Deviant at 2nd Trial", 
    sequence_scheme == "BBBDBB" ~ "Deviant at 4th Trial", 
    sequence_scheme == "BBBBBD" ~ "Deviant at Last Trial"
  )) %>% 
  group_by(trial_number, sequence_scheme, sequence_scheme_print, block_type) %>%
  summarise(
    trial_looking_time = mean(trial_looking_time), 
    log_trial_looking_time = mean(log(trial_looking_time))
  ) %>% 
  separate(block_type, into = c("complexity", "similarity"), sep = "_")

b_res_summary
```


# preprocess simulation results 

```{r}
sim_res_sum <- sim_res %>% 
  group_by(params_info, stim_info, stimulus_idx) %>% 
  summarise(
    trial_sim_res = mean(sample_n), 
    log_trial_sim_res = mean(log(sample_n))
  ) %>% 
  filter(!is.na(stim_info)) %>% 
  filter(!grepl("nf_10_of_3", stim_info)) %>% 
  mutate(
    sequence_scheme =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", sequence_scheme), ""), 
    complexity = case_when(
      stimuli_rep == "nf_10_of_1" ~ "simple", 
      stimuli_rep == "nf_10_of_5" ~ "complex"
    )
  ) %>% 
  rename(trial_number = stimulus_idx)
```


```{r}
sim_b_res <- sim_res_sum %>% 
  left_join(b_res_summary, by = c("trial_number", "sequence_scheme", "complexity")) 
```

# Visualization 

## behavioral results 




```{r}
b_res_print %>% 
  ggplot(aes(x=trial_number, y=log(trial_looking_time), color = complexity)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2))+
  #geom_smooth(method = "lm", 
  #            formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number")

```




## model results 
(select the best parameters?)
```{r}
sim_res_sum %>% 
  mutate(
     sequence_scheme_print = case_when(
    sequence_scheme == "BBBBBB" ~ "No Deviant", 
    sequence_scheme == "BDBBBB" ~ "Deviant at 2nd Trial", 
    sequence_scheme == "BBBDBB" ~ "Deviant at 4th Trial", 
    sequence_scheme == "BBBBBD" ~ "Deviant at Last Trial")
  ) %>% 
  filter(params_info == "ae_1_be_10_ap_1_bp_30_np_0.05_wEIG_0.01") %>% 
  ggplot(aes(x = trial_number, y = log_trial_sim_res, color = complexity)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",position = position_dodge(width = .2)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  facet_wrap(~sequence_scheme_print) + 
  ylab("Sample per trial (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "model results: parameter info") + 
  langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple"))  +
  theme(legend.position = "bottom") 


```

# transform model results to match mean and standard deviation 

```{r}
sim_b_res %>% 
  group_by(params_info) %>% 
  summarise(
    mean_log_trial_sim_res = mean(log_trial_sim_res),  # m1
    sd_log_trial_sim_res = sd(log_trial_sim_res), # s1
    mean_log_trial_looking_time = mean(log_trial_looking_time), # m2
    sd_log_trial_looking_time = sd(log_trial_looking_time) # s2
  ) %>% 
  mutate(
    multiply_const = sd_log_trial_looking_time / sd_log_trial_sim_res # s2/s1
  ) %>% 
  left_join(sim_b_res, by = c("params_info")) %>% 
  # currently just looking at one set of parameter
  filter(params_info == "ae_1_be_10_ap_1_bp_30_np_0.05_wEIG_0.01") %>% 
  mutate(
    scaled_log_trial_sim_res = mean_log_trial_looking_time + (log_trial_sim_res - mean_log_trial_sim_res) * multiply_const
  ) %>% 
  pivot_longer(cols = c("log_trial_looking_time", "scaled_log_trial_sim_res"), 
               names_to = "res_type", 
               values_to = "res") %>% 
  mutate(
    `Result Type` = case_when(
      res_type == "log_trial_looking_time" ~ "Behavioral Results", 
      res_type == "scaled_log_trial_sim_res" ~ "Scaled Model Results",
    )
  ) %>% 
  ggplot(aes(x = trial_number, y = res,  color = complexity, linetype = `Result Type`, shape = `Result Type`)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", position = position_dodge(width = .5)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~sequence_scheme_print) + 
  ylab("Sample per trial (log)") + 
  xlab("Trial number") + 
  theme_classic() + 
  labs(title = "model results: parameter info")
```

```{r}

# scaled with average of the average 
scaled_model_res <- sim_b_res %>% 
  group_by(params_info) %>% 
  summarise(
    mean_log_trial_sim_res = mean(log_trial_sim_res),  # m1
    sd_log_trial_sim_res = sd(log_trial_sim_res), # s1
    mean_log_trial_looking_time = mean(log_trial_looking_time), # m2
    sd_log_trial_looking_time = sd(log_trial_looking_time) # s2
  ) %>% 
  mutate(
    multiply_const = sd_log_trial_looking_time / sd_log_trial_sim_res # s2/s1
  ) %>% 
  left_join(sim_b_res, by = c("params_info")) %>% 
  # currently just looking at one set of parameter
  filter(params_info == "ae_1_be_10_ap_1_bp_30_np_0.05_wEIG_0.01") %>% 
  mutate(
    scaled_log_trial_sim_res = mean_log_trial_looking_time + (log_trial_sim_res - mean_log_trial_sim_res) * multiply_const
  ) %>% 
  pivot_longer(cols = c("log_trial_looking_time", "scaled_log_trial_sim_res"), 
               names_to = "res_type", 
               values_to = "res") %>% 
  mutate(
    `Result Type` = case_when(
      res_type == "log_trial_looking_time" ~ "Behavioral Results", 
      res_type == "scaled_log_trial_sim_res" ~ "Scaled Model Results",
    )
  ) %>% 
  filter(`Result Type` == "Scaled Model Results") 
```

```{r}
b_res_print
```


```{r}
scaled_model_res <- b_res_print %>% 
  left_join(sim_res_sum %>% filter(params_info == "ae_1_be_10_ap_1_bp_25_np_0.05_wEIG_0.01"), by = c("trial_number", "complexity", "sequence_scheme")) %>% 
  group_by(params_info) %>% 
  summarise(
    mean_log_trial_sim_res = mean(log_trial_sim_res),  # m1
    sd_log_trial_sim_res = sd(log_trial_sim_res), # s1
    mean_log_trial_looking_time = mean(log(trial_looking_time)), # m2
    sd_log_trial_looking_time = sd(log(trial_looking_time)) # s2
  ) %>% 
  left_join(sim_b_res, by = "params_info") %>% 
  mutate(
    multiply_const = sd_log_trial_looking_time / sd_log_trial_sim_res # s2/s1
  ) %>% 
  mutate(
    scaled_log_trial_sim_res = mean_log_trial_looking_time + (log_trial_sim_res - mean_log_trial_sim_res) * multiply_const
  ) 
  
```

```{r}
b_res_print
scaled_model_res

```


```{r}
b_res_print %>% 
  ggplot(aes(x=trial_number, y=log(trial_looking_time), color = complexity)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2))+
   geom_point(data = scaled_model_res, mapping = aes(x = trial_number, y = scaled_log_trial_sim_res, color = complexity)) + 
  geom_line(data = scaled_model_res, mapping = aes(x = trial_number, y = scaled_log_trial_sim_res, color = complexity), linetype = "dashed") + 
  #stat_summary(data = scaled_model_res, 
   #            mapping = (aes(x = trial_number, y = scaled_log_trial_sim_res, color = complexity)), 
    #           fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  #stat_summary(data = scaled_model_res, 
  #             mapping = (aes(x = trial_number, y = scaled_log_trial_sim_res, color = complexity)), 
   #            fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  #geom_smooth(method = "lm", 
  #            formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_wrap(~sequence_scheme_print) +
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  #langcog::theme_mikabr() +
  theme_classic()+
  #langcog::scale_color_solarized(name = "Trial Complexity",labels = c("Complex", "Simple")) + 
  theme(legend.position = "bottom") + 
  ylab("log Looking time (seconds)") + 
  xlab("Trial Number")  + 
  labs(lineshape = "legend")
```



## correlation between samples and RT 

```{r}
sim_b_res %>% 
  ggplot(aes(x = log(trial_looking_time), 
             y = log(trial_sim_res), 
             color = params_info)) + 
 scale_x_log10() + 
  scale_y_log10() + 
  geom_point()  + 
  geom_smooth(method = "lm") + 
  ylab("Looking time (log)") + 
  xlab("Simulation Results (log)")  + 
  theme_classic() #+ 
  #facet_wrap(~sequence_scheme)
```

## separting deviant and background? 

```{r}
sim_b_res %>% 
  mutate(trial_type = case_when(
    sequence_scheme == "BBBBBB" ~ "background_before", 
    sequence_scheme == "BDBBBB" & trial_number == 2 ~ "deviant", 
    sequence_scheme == "BDBBBB" & trial_number < 2 ~ "background_before", 
    sequence_scheme == "BDBBBB" & trial_number > 2 ~ "background_after", 
    
    sequence_scheme == "BBBDBB" & trial_number == 4 ~ "deviant", 
    sequence_scheme == "BBBDBB" & trial_number < 4 ~ "background_before", 
    sequence_scheme == "BBBDBB" & trial_number > 4 ~ "background_after", 

    sequence_scheme == "BBBBBD" & trial_number == 6 ~ "deviant", 
    sequence_scheme == "BBBBBD" & trial_number < 6 ~ "background_before", 
    sequence_scheme == "BBBBBD" & trial_number > 6 ~ "background_after"
  )) %>% 
  ungroup() %>% 
  group_by(params_info, stim_info)
  

```



# Stats

## Calculating perason correlation for each set of parameter (overall)

```{r}
d <- sim_b_res %>% 
  ungroup() %>% 
  nest_by(params_info) 

d$perason_corr <- unlist(map(d$data, function(x){
   pearson_r <- cor(x$trial_sim_res, x$trial_looking_time, method = "pearson")
    }))
d$perason_corr_in_log <- unlist(map(d$data, function(x){
   pearson_r_in_log <- cor(x$log_trial_sim_res, x$log_trial_looking_time, method = "pearson")
    }))
  
  
d  

```





```{r}
sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  filter(!is.na(stimuli_sequence)) %>% 
  ggplot(aes(x = stimulus_idx, y = sample_n, color = stimuli_rep)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_grid(params_info~stimuli_sequence) + 
  theme_classic()
  
```

# now let's just look at deviant 

```{r}
sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  mutate(
    deviant_position = case_when(
      stimuli_sequence == "BDBBBB" ~ 2, 
      stimuli_sequence == "BBBDBB" ~ 4,
      stimuli_sequence == "BBBBBD" ~ 6, 
      TRUE ~ 0
    ), 
    stimuli_type = case_when(
      stimulus_idx == deviant_position ~ "deviant", 
      TRUE ~ "background"
    )
  ) %>% 
  filter(stimuli_type == "deviant") %>% 
  ggplot(aes(x = deviant_position, y = sample_n, color = stimuli_rep)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~params_info) +
  theme_classic() + 
  labs(title = "absolute sample n for deviant")
```


```{r}
dev_df <- sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  mutate(
    deviant_position = case_when(
      stimuli_sequence == "BDBBBB" ~ 2, 
      stimuli_sequence == "BBBDBB" ~ 4,
      stimuli_sequence == "BBBBBD" ~ 6, 
      TRUE ~ 0
    ), 
    stimuli_type = case_when(
      stimulus_idx == deviant_position ~ "deviant", 
      TRUE ~ "background"
    )
  ) %>% 
  filter(stimuli_type == "deviant") %>% 
  ungroup()

dev_df <- dev_df %>% 
  rename(deviant_n = sample_n) %>% 
  select(stimulus_idx, deviant_n, params_info, stimuli_rep, deviant_position) %>% 
  ungroup() %>% 
  group_by(params_info, stimuli_rep, .drop = FALSE) %>%
  mutate(base_id = row_number())


sim_res %>%
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  filter(stimuli_sequence == "BBBBBB") %>%
  rename(background_n = sample_n) %>% 
  filter(stimulus_idx %in% c(2, 4, 6)) %>% 
  ungroup() %>% 
  group_by(params_info, stimuli_rep, .drop = FALSE) %>% 
  mutate(base_id = row_number()) %>% 
  left_join(dev_df, by = c("base_id", "stimuli_rep", "params_info")) %>% 
  mutate(
    relative_dishab = deviant_n - background_n
  ) %>% 
  ggplot(aes(x = deviant_position, y = relative_dishab, color = stimuli_rep)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~params_info) +
  theme_classic() + 
  labs(title = "relative n for deviant")
  
```


```{r}
fam_res <- readRDS(here("model/cached_data/fam_sim_res.RDS"))

```

```{r}
fam_res %>% 
  rowwise() %>% 
  mutate(
    stimuli_sequence =  sub(".*_", "", stim_info),
    stimuli_rep = str_replace(stim_info, paste0("_", "ss_", stimuli_sequence), "")
  ) %>% 
  filter(!is.na(stimuli_sequence)) %>% 
  ggplot(aes(x = stimulus_idx, y = sample_n, color = stimuli_rep)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .5)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .5)) + 
  facet_wrap(~params_info) + 
  theme_classic()
```

